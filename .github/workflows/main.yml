name: Monitor Secret Key Leakage (Upstream Only)

on:
  push:
    branches:
      - "**"

jobs:
  scan:
    # â›” Jangan jalan di fork sendiri
    if: github.event.repository.fork == false

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan for secret key
        id: scan
        run: |
          echo "Scanning upstream repository for sk.bin..."

          if find . -type f -name "sk.bin" | grep -q .; then
            echo "FOUND_SK=1" >> $GITHUB_ENV
            echo "âŒ sk.bin FOUND"
          else
            echo "FOUND_SK=0" >> $GITHUB_ENV
            echo "âœ” No sk.bin found"
          fi

      - name: Send Telegram alert (ONLY if sk.bin found)
        if: env.FOUND_SK == '1'
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="ðŸš¨ *CRITICAL ALERT*\n\nsk.bin detected in UPSTREAM repository!\n\nRepo: ${{ github.repository }}\nBranch: ${{ github.ref_name }}\nCommit: ${{ github.sha }}\nActor: ${{ github.actor }}\n\nCheck immediately." \
            -d parse_mode=Markdown

      - name: Fail workflow if sk.bin detected
        if: env.FOUND_SK == '1'
        run: |
          echo "::error ::sk.bin detected in upstream repository"
          exit 1
